<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valutazione Blind Audio</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f9; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
        .user-info { text-align: center; margin-bottom: 30px; color: #7f8c8d; font-size: 0.9em; }
        
        /* Stile Lista Tracce */
        .track-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .track-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 10px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }
        .track-row:hover { background-color: #f9f9f9; }

        /* Colonna Numero */
        .track-number {
            font-weight: bold;
            color: #3498db;
            width: 40px;
            text-align: center;
            font-size: 1.1em;
        }

        /* Player Audio */
        audio { 
            flex-grow: 1;
            margin: 0 20px; 
            height: 40px; 
        }
        
        /* Dropdown Selezione */
        select.emotion-select {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #bdc3c7;
            background-color: white;
            width: 160px;
            cursor: pointer;
            font-size: 1em;
        }
        select.emotion-select:focus { border-color: #3498db; outline: none; }

        /* Bottone Finale */
        .submit-section { text-align: center; margin-top: 40px; }
        button#btnInvia {
            background-color: #3498db; color: white; border: none;
            padding: 15px 50px; font-size: 1.2em; border-radius: 50px;
            cursor: pointer; transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button#btnInvia:hover { background-color:  #5aade5; transform: translateY(-2px); }
        button#btnInvia:disabled { background-color: #95a5a6; cursor: not-allowed; transform: none; }

    </style>
</head>
<body>

    <div class="container">
        <h1>Blind Evaluation Test</h1>
        <div class="user-info">ID Valutatore: <span id="displayUserId">...</span></div>
        
        <div id="loading-msg" style="text-align:center; padding: 20px;">Caricamento tracce in corso...</div>
        
        <div id="main-list-container"></div>

        <div class="submit-section">
            <button id="btnInvia" onclick="inviaRisultati()"><strong>Invia Valutazione</strong></button>
        </div>
    </div>

    <script>
        // 1. ID Utente Casuale
        const userId = Math.floor(1000 + Math.random() * 9000);
        document.getElementById('displayUserId').innerText = userId;

        // Opzioni disponibili (Puoi aggiungerne altre qui se vuoi)
        const options = ["Happy", "Sad", "Neutral"];

        // 2. Caricamento File dal Server
        fetch('/lista-audio')
        .then(res => res.json())
        .then(files => {
            document.getElementById('loading-msg').style.display = 'none';
            
            // Mischiamo tutto l'array dei file (nessun raggruppamento)
            const shuffledFiles = shuffle(files);
            
            renderizzaLista(shuffledFiles);
        })
        .catch(err => {
            document.getElementById('loading-msg').innerText = "Errore nel caricamento file.";
            console.error(err);
        });

        // Algoritmo di Shuffle (Fisher-Yates)
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 3. Renderizza la Lista Unica
        function renderizzaLista(files) {
            const container = document.getElementById('main-list-container');
            container.innerHTML = ""; // Pulisce

            files.forEach((filename, index) => {
                const row = document.createElement('div');
                row.className = 'track-row';
                
                // Creiamo le opzioni del menu a tendina
                const optionsHtml = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');

                row.innerHTML = `
                    <div class="track-number">${index + 1}</div>
                    <audio controls src="/audio/${filename}" controlsList="nodownload"></audio>
                    <select class="emotion-select" data-real-filename="${filename}">
                        <option value="" disabled selected>-- Scegli --</option>
                        ${optionsHtml}
                    </select>
                `;
                container.appendChild(row);
            });
        }

        // 4. Invio Dati
        function inviaRisultati() {
            const selects = document.querySelectorAll('select.emotion-select');
            let risultati = [];
            let incompleto = false;

            // Raccogli i dati
            selects.forEach(sel => {
                if (!sel.value) {
                    sel.style.border = "2px solid #e74c3c"; // Rosso se manca
                    incompleto = true;
                } else {
                    sel.style.border = "1px solid #bdc3c7"; // Reset stile
                    
                    const filename = sel.dataset.realFilename;
                    
                    // Estraggo l'ID dal nome file (es. "12_pos.wav" -> "12") 
                    // per mantenere il CSV pulito come richiesto.
                    const filePrefix = filename.split('_')[0]; 

                    risultati.push({
                        gruppo: filePrefix, // Mantiene la coerenza col vecchio CSV
                        file_reale: filename,
                        emozione: sel.value
                    });
                }
            });

            if (incompleto) {
                alert("Attenzione: devi valutare tutte le tracce prima di inviare!");
                return;
            }

            // Disabilita bottone
            const btn = document.getElementById('btnInvia');
            btn.disabled = true;
            btn.innerText = "Salvataggio...";

            // Invio al server
            fetch('/salva-test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: userId, risultati: risultati })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'successo') {
                    alert("Valutazione salvata con successo! Grazie.");
                    window.scrollTo(0, 0);
                    location.reload(); // Ricarica per il prossimo utente
                } else {
                    alert("Errore nel salvataggio: " + data.msg);
                    btn.disabled = false;
                    btn.innerText = "Invia Valutazione";
                }
            })
            .catch(err => {
                console.error(err);
                alert("Errore di connessione col server.");
                btn.disabled = false;
                btn.innerText = "Invia Valutazione";
            });
        }
    </script>
</body>
</html>